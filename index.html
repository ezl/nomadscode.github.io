<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="static/css/custom.css">
  <script src='https://cdn.firebase.com/js/client/2.0.4/firebase.js'></script>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src='static/js/jquery.serializeObject.js'></script>

</head>
<body>
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">Nomads Code</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div id="main">
      <div class="row">
        <div class="col-md-6">
        <img src="static/images/nomads_code_logo.png">
        <p>Code share for digtal nomads. Mix of public and private projects. Request access @nomadscode on Twitter.</p>
        <a href="https://twitter.com/intent/tweet?screen_name=nomadscode&text=add%20me%20%3A)" class="twitter-mention-button" data-size="large" data-related="partysandy_,nomadscode">Tweet to @nomadscode</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      </div>
        </div><!-- .col-md-6 -->
      </div><!-- .row -->

      <hr>

      <section id="formForAddingUsers"><!-- the form input -->
        <div class="row">
          <div class="col-md-12">
            <form id="addUser" class="form well">
              <div class="row">
                <div class="col-sm-6">
                  <p class="title">Hi. on Slack/hashtagnomads, I am</p>
                  <div class="form-group">
                    <label class="sr-only" for="slackUsername">Slack Username</label>
                    <input type="text" class="form-control" name="slackUsername" id="slackUsername" placeholder="Your Slack Username">
                  </div>
                </div><!-- .col-sm-6 -->
                <div class="col-sm-6">
                  <p class="title">I am mostly interested in</p>
                   <div class="radio">
                     <label>
                       <input type="radio" name="hiringOrForHire" id="forHireRadio" value="forHire" checked>
                       Being Hired
                     </label>
                   </div><!-- .radio -->
                   <div class="radio">
                     <label>
                       <input type="radio" name="hiringOrForHire" id="hiringRadio" value="hiring">
                       Hiring People
                     </label>
                   </div><!-- .radio -->
                </div><!-- .col-sm-6 -->
              </div><!-- .row -->

              <div class="row">
                <div class="col-sm-6">
                  <p class="title forHire">I primarily work with these skills/technologies</p>
                  <p class="title hiring" style="display:none;">I want to hire someone with these skills/technologies</p>
                  <textarea class="form-control" id="skills" name="skills" rows="3"></textarea>
                  <p class="helptext">Python, Ruby, PHP, Wordpress, SEO, Design Work, UI/UX Consulting, Marketing, Copy Writing, Social Media Management, etc.</p>
                  <p class="helptext">One per row, maximum of 4.</p>
                </div><!-- .col-sm-6 -->
                <div class="col-sm-6 forHire">
                  <p class="title">My Weekly Rate In USD Is:</p>
                  <div class="form-group">
                    <label class="sr-only" for="weeklyRate">Weekly Rate</label>
                    <input type="number" class="form-control" id="weeklyRate" name="weeklyRate">
                    <p class="helptext">Pick a weekly number you'd be comfortable with for a gig you'd like.</p>
                    <p class="helptext">Yes, "it varies".  But use a starting anchor on a weekly timeframe you're comfortable with and people can connect and individually negotiate hourly or monthly or per project situations.</p>
                  </div>
                </div><!-- .col-sm-6 -->
              </div><!-- .row -->

              <div class="row">
                <div class="col-sm-12">
                  <div class="form-group">
                    <p class="title">It would be awesome to work with me because...</p>
                    <label class="sr-only" for="aboutMe">About Me</label>
                    <textarea class="form-control" rows="3" id="aboutMe" name="aboutMe" placeholder="You're a precious snowflake.  I know you want to tell me all about it. Here's your chance to tell your next employee/employer why working with you is a delight and a privilege."></textarea>
                  </div>
                </div><!-- .col-sm-12 -->
              </div><!-- .row -->
              <button type="submit" class="btn btn-primary"><i class="fa fa-plus-circle"></i> Add Me To The List</button>
            </form>
          </div><!-- .col-md-12 -->
        </div><!-- .row -->
      </section><!-- end add user form area -->

      <section id="displayUsers">
        <div class="row">
          <div class="col-md-12">
            <table class="table table-striped table-condensed table-hover" id="usersTable">
              <thead>
                <tr>
                  <th>Slack Handle</th>
                  <th>Hiring/For Hire</th>
                  <th>Skills</th>
                  <th>Weekly Rate (USD)</th>
                  <th>I'm Awesome Because</th>
                  <th>Time Zone</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div><!-- .col-md-12 -->
        </div><!-- .row -->
      </section><!-- end area for displaying users -->

    </div><!-- #main -->
  </div><!-- .container -->

  <div class="modal fade" id="invalidUsernameModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header modal-header-red">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><i class="fa fa-warning"></i> Hmmm... We couldn't find your username.</h4>
        </div>
        <div class="modal-body">
          <p>This list is intended as a private list between members of <a href="http://hashtagnomads.com/">#nomads</a>, a membership subscription group of digital nomads.</p>
          <p>If you're not a member, please join by signing up here: <a href="http://hashtagnomads.com/">http://hashtagnomads.com/</a>.</p>
          <p class="helptext">There is a small, one-time membership fee to join the group.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">OK</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script type='text/javascript'>
    jQuery(document).ready(function(){
      // Show or Hide fields based on whether the user wants to hire or be hired
      $('input:radio[name="hiringOrForHire"]').change(function() {
          if ($(this).is(':checked') && $(this).val() == 'forHire') {
            $(".forHire").show();
            $(".hiring").hide();
          } else {
            $(".forHire").hide();
            $(".hiring").show();
          }
      });

      // Slack stuff
      var slackAPIToken = "xoxp-2551684328-3348307022-3390743792-74b817";

      // Get slack Users
      var endpoint = "https://slack.com/api/users.list?token=" + slackAPIToken;
      $.getJSON(endpoint, function(data) {
        var members = data.members;
        // The list of objects sucks for search, so lets remake it to make it easier to use later.
        var slackUsers = {};
        $.each(members, function(index, member) {
          slackUsers[member.name] = member;
        });
        window.slackUsers = slackUsers;
      })

      slackUserExists = function(slackUsername) {
        return slackUsername in slackUsers;
      }

      // Insert a new table row for a user
      var insertUserInTable = function(snapshot) {
        var data = snapshot.val();
        var newTableRow = $("<tr/>");
        newTableRow.append($("<td/>").text(data.slackUsername));
        newTableRow.append($("<td/>").text(data.hiringOrForHire));
        newTableRow.append($("<td/>").text(data.skills));
        newTableRow.append($("<td/>").text(data.weeklyRate));
        newTableRow.append($("<td/>").text(data.aboutMe));
        newTableRow.append($("<td/>").text(data.timezone));
        $("#usersTable > tbody").append(newTableRow);
      }

      // Create our Firebase reference
      var fb = new Firebase('https://amber-heat-8792.firebaseio.com/');

      // Set up the view
      var usersView =  fb.orderByKey()

      // Set callback for when a user is added
      usersView.on('child_added', function(snapshot, previousChildKey) {
        insertUserInTable(snapshot);
      });

      // Listen for form input and save to firebase
      $("#addUser").on("submit", function(event) {
        event.preventDefault();
        var slackUsername = $("#slackUsername").val();
        if (!slackUserExists(slackUsername)) {
          $("#invalidUsernameModal").modal();
          return;
        }
        var data = $(this).serializeObject();
        var timezone = slackUsers[slackUsername]['tz'];
        data['timezone'] = timezone;
        fb.child(data.slackUsername).set(data);
      });

    });
  </script> 
  </body>
</html>
